## Redis 有几种数据结构？Zset 是如何实现的？
## 简述 Redis 持久化中 rdb 以及 aof 方案的优缺点
### 持久化机制
Redis快很大一部分原因是因为它数据都是存储在内存中，当断电或重启就会存在数据丢失，为了实现重启后数据不丢失，Redis提供了两种数据持久化方案rdb（Redis DataBase快照）和aof（AppendOnlyFile）。默认是使用rdb，当开启了aof时，优先使用aof。
#### rdb
- 触发方式
  - 自动触发：我们可以设置自动触发的规则（save+时间间隔单位秒+保存key数量），有多个规则时，规则都会生效。比如save 100 10就是100秒至少10个key被修改，就触发保存。当shutdown的时候也会生成快照dump.rdb ，在安装根目录下。
  - 手动触发
    - save：会阻塞Redis服务器
    - bgsave：fork一个子进程进行快照，不会影响redis的使用，fork之后的修改不会保存到快照中
- 恢复：Redis启动时会自动恢复数据

#### aof
- 备份方式：redis会将所有命令追加到文件中，当redis重启时，会将命令重新执行一次。当追加命令越来越多，aof文件越来越大时，Redis会对根据存在的key对key命令操作进行重写（可以设置重写key操作的文件大小，也可以手动通过`bgrewriteaof`）。
- 启用方式：设置appenonly为yes

### rdb与aof优缺点
- rdb
  - 优点
    - 相对aof，数据格式更合适备份与容灾，没有重复命令那些
    - 恢复数据时比aof快
    - 备份数据时是子进程备份，不影响redis使用
  - 缺点
    - 快照之后的修改数据会丢失（无法频繁的做持久化，因为是创建子进程方式，频繁执行，代价太高）
- aof
  - 优点
    - 数据丢失较少
  - 缺点
    - 备份文件体积更大，恢复更慢
    - 高并发下，频繁append没有rdb子进程方式效率高
## Redis 如何实现延时队列，分布式锁的实现原理
### 延时队列
可以使用zset做延时队列，用设置好的时间戳作为score进行排序。查询时用zrangebyscore查询符合条件的待处理的任务。
- 优势
  - 在内存上操作，速度快
  - 高性能的score排序
  - redis有持久化，数据不会丢失

- 劣势
  - 没有重试机制
  - 没有ACK机制，无法保证消息被正确消费
### 分布式锁
分布式锁的基本要求：
- 互斥性：只有一个客户端能持有锁
- 不会产生死锁：即使持有锁的客户端过期了，其他客户端也要可以获取锁
- 只有持有锁的客户端才能解锁

#### 加锁
```java
SET key requestId NX PX 300
```
- key：分布式锁的key
- requestId：表明是哪个客户端，加锁的才能释放锁（除了锁过期）
- NX：设置值如果不存在
- PX：过期时间单位，PX为毫秒，也可以设置秒为EX
- 300：过期时间长度
#### 释放锁
为了避免误解锁，不是持有锁的客户端解了锁，两个客户端A与B，A持有锁，锁解锁判断时A客户端id对上，准备解锁，这时锁过期时间到达，B获取到了锁，A继续解锁，A就解掉了不属于自己自己的锁。为了解决这个问题，使用lua脚本原子解锁。
```java
if redis.call("get",KEYS[1]) == ARGV[1] then
        return redis.call("del",KEYS[1])
    else
        return 0
    end
```
## 简述 Redis 中如何防止缓存雪崩和缓存击穿
### 缓存雪崩
Redis大量的热点数据同时过期（因为设置了相同的过期时间），大量请求落在数据库上，称为**缓存雪崩**。单个的热点数据失效，导致大量请求落在数据库上称为**缓存击穿**。
- 解决方法
  - 加互斥锁，针对同一个热点key，只允许一个线程去数据库获取数据（其余没抢到锁的线程都再次获取，再次获取时，前面抢到锁的线程将对应key缓存加到redis里了）
  - 定时更新缓存，避免失效
  - 设置key的过期时间时，加随机数，避免同时失效
  - 设置缓存永不过期
### 缓存穿透
访问的值在`redis`和数据库中都没有，可能是由于程序错误或者恶意攻击。
- 解决方法
  - 缓存空值或者特殊字符：需要设置过期时间，并且无法解决每次查询都是**不一样的不存在值**得问题。
  - 布隆过滤器：缓存数据库现有值，当有查询来时，可以判断这个值是否存在，两种情况1）判断值存在，由于hash冲突，值可能是不存在的（即布隆过滤器有一定误判性）。2）判断值不存在，值肯定不存在。这样就只有很少的误判值才能去查询数据库。todo补一批讲解布隆过滤器的



## 简述 Redis 中跳表的应用以及优缺点
## 假设Redis 的 master 节点宕机了，你会怎么进行数据恢复？

